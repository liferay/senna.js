define(["exports","metal/src/metal"],function(t,e){/*!
   * Promises polyfill from Google's Closure Library.
   *
   *      Copyright 2013 The Closure Library Authors. All Rights Reserved.
   *
   * NOTE(eduardo): Promise support is not ready on all supported browsers,
   * therefore metal-promise is temporarily using Google's promises as polyfill.
   * It supports cancellable promises and has clean and fast implementation.
   */
"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(t,"__esModule",{value:!0}),t.CancellablePromise=void 0;var o=function(){};o.prototype.then=function(){},o.IMPLEMENTED_BY_PROP="$goog_Thenable",o.addImplementation=function(t){t.prototype.then=t.prototype.then,t.prototype.$goog_Thenable=!0},o.isImplementedBy=function(t){if(!t)return!1;try{return!!t.$goog_Thenable}catch(e){return!1}};var a=function(t){var e=Array.prototype.slice.call(arguments,1);return function(){var n=e.slice();return n.push.apply(n,arguments),t.apply(this,n)}},c=function r(t,e){this.state_=r.State_.PENDING,this.result_=void 0,this.parent_=null,this.callbackEntries_=null,this.executing_=!1,r.UNHANDLED_REJECTION_DELAY>0?this.unhandledRejectionId_=0:0===r.UNHANDLED_REJECTION_DELAY&&(this.hadUnhandledRejection_=!1);try{var n=this;t.call(e,function(t){n.resolve_(r.State_.FULFILLED,t)},function(t){n.resolve_(r.State_.REJECTED,t)})}catch(i){this.resolve_(r.State_.REJECTED,i)}};c.UNHANDLED_REJECTION_DELAY=0,c.State_={PENDING:0,BLOCKED:1,FULFILLED:2,REJECTED:3},c.CallbackEntry_=null,c.resolve=function(t){return new c(function(e){e(t)})},c.reject=function(t){return new c(function(e,n){n(t)})},c.race=function(t){return new c(function(e,n){t.length||e(void 0);for(var i,l=0;i=t[l];l++)i.then(e,n)})},c.all=function(t){return new c(function(e,n){var i=t.length,l=[];if(!i)return void e(l);for(var o,c=function(t,n){i--,l[t]=n,0===i&&e(l)},r=function(t){n(t)},s=0;o=t[s];s++)o.then(a(c,s),r)})},c.firstFulfilled=function(t){return new c(function(e,n){var i=t.length,l=[];if(!i)return void e(void 0);for(var o,c=function(t){e(t)},r=function(t,e){i--,l[t]=e,0===i&&n(l)},s=0;o=t[s];s++)o.then(c,a(r,s))})},c.prototype.then=function(t,n,i){return this.addChildPromise_((0,e.isFunction)(t)?t:null,(0,e.isFunction)(n)?n:null,i)},o.addImplementation(c),c.prototype.thenAlways=function(t,e){var n=function(){try{t.call(e)}catch(n){c.handleRejection_.call(null,n)}};return this.addCallbackEntry_({child:null,onRejected:n,onFulfilled:n}),this},c.prototype.thenCatch=function(t,e){return this.addChildPromise_(null,t,e)},c.prototype["catch"]=c.prototype.thenCatch,c.prototype.cancel=function(t){this.state_===c.State_.PENDING&&e.async.run(function(){var e=new c.CancellationError(t);e.IS_CANCELLATION_ERROR=!0,this.cancelInternal_(e)},this)},c.prototype.cancelInternal_=function(t){this.state_===c.State_.PENDING&&(this.parent_?this.parent_.cancelChild_(this,t):this.resolve_(c.State_.REJECTED,t))},c.prototype.cancelChild_=function(t,e){if(this.callbackEntries_){for(var n,i=0,l=-1,o=0;n=this.callbackEntries_[o];o++){var a=n.child;if(a&&(i++,a===t&&(l=o),l>=0&&i>1))break}if(l>=0)if(this.state_===c.State_.PENDING&&1===i)this.cancelInternal_(e);else{var r=this.callbackEntries_.splice(l,1)[0];this.executeCallback_(r,c.State_.REJECTED,e)}}},c.prototype.addCallbackEntry_=function(t){this.callbackEntries_&&this.callbackEntries_.length||this.state_!==c.State_.FULFILLED&&this.state_!==c.State_.REJECTED||this.scheduleCallbacks_(),this.callbackEntries_||(this.callbackEntries_=[]),this.callbackEntries_.push(t)},c.prototype.addChildPromise_=function(t,n,i){var l={child:null,onFulfilled:null,onRejected:null};return l.child=new c(function(o,a){l.onFulfilled=t?function(e){try{var n=t.call(i,e);o(n)}catch(l){a(l)}}:o,l.onRejected=n?function(t){try{var l=n.call(i,t);!(0,e.isDef)(l)&&t.IS_CANCELLATION_ERROR?a(t):o(l)}catch(c){a(c)}}:a}),l.child.parent_=this,this.addCallbackEntry_(l),l.child},c.prototype.unblockAndFulfill_=function(t){if(this.state_!==c.State_.BLOCKED)throw new Error("CancellablePromise is not blocked.");this.state_=c.State_.PENDING,this.resolve_(c.State_.FULFILLED,t)},c.prototype.unblockAndReject_=function(t){if(this.state_!==c.State_.BLOCKED)throw new Error("CancellablePromise is not blocked.");this.state_=c.State_.PENDING,this.resolve_(c.State_.REJECTED,t)},c.prototype.resolve_=function(t,n){if(this.state_===c.State_.PENDING){if(this===n)t=c.State_.REJECTED,n=new TypeError("CancellablePromise cannot resolve to itself");else{if(o.isImplementedBy(n))return n=n,this.state_=c.State_.BLOCKED,void n.then(this.unblockAndFulfill_,this.unblockAndReject_,this);if((0,e.isObject)(n))try{var i=n.then;if((0,e.isFunction)(i))return void this.tryThen_(n,i)}catch(l){t=c.State_.REJECTED,n=l}}this.result_=n,this.state_=t,this.scheduleCallbacks_(),t!==c.State_.REJECTED||n.IS_CANCELLATION_ERROR||c.addUnhandledRejection_(this,n)}},c.prototype.tryThen_=function(t,e){this.state_=c.State_.BLOCKED;var n=this,i=!1,l=function(t){i||(i=!0,n.unblockAndFulfill_(t))},o=function(t){i||(i=!0,n.unblockAndReject_(t))};try{e.call(t,l,o)}catch(a){o(a)}},c.prototype.scheduleCallbacks_=function(){this.executing_||(this.executing_=!0,e.async.run(this.executeCallbacks_,this))},c.prototype.executeCallbacks_=function(){for(;this.callbackEntries_&&this.callbackEntries_.length;){var t=this.callbackEntries_;this.callbackEntries_=[];for(var e=0;e<t.length;e++)this.executeCallback_(t[e],this.state_,this.result_)}this.executing_=!1},c.prototype.executeCallback_=function(t,e,n){e===c.State_.FULFILLED?t.onFulfilled(n):(this.removeUnhandledRejection_(),t.onRejected(n))},c.prototype.removeUnhandledRejection_=function(){var t;if(c.UNHANDLED_REJECTION_DELAY>0)for(t=this;t&&t.unhandledRejectionId_;t=t.parent_)clearTimeout(t.unhandledRejectionId_),t.unhandledRejectionId_=0;else if(0===c.UNHANDLED_REJECTION_DELAY)for(t=this;t&&t.hadUnhandledRejection_;t=t.parent_)t.hadUnhandledRejection_=!1},c.addUnhandledRejection_=function(t,n){c.UNHANDLED_REJECTION_DELAY>0?t.unhandledRejectionId_=setTimeout(function(){c.handleRejection_.call(null,n)},c.UNHANDLED_REJECTION_DELAY):0===c.UNHANDLED_REJECTION_DELAY&&(t.hadUnhandledRejection_=!0,e.async.run(function(){t.hadUnhandledRejection_&&c.handleRejection_.call(null,n)}))},c.handleRejection_=e.async.throwException,c.setUnhandledRejectionHandler=function(t){c.handleRejection_=t},c.CancellationError=function(t){function e(t){n(this,e);var l=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return t&&(l.message=t),l}return l(e,t),e}(Error),c.CancellationError.prototype.name="cancel",t.CancellablePromise=c,t["default"]=c});